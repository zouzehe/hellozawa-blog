---
title: 服务搭建流水账
date: 2018-10-25 23:12:06
tags: linux
---
前段在开发一个区块链钱包项目，在准备一些线上及测试环境
包含后台服务及web服务
纯做记录

### 配置
>硬件配置 4核16G
>Linux版本 Centos 7.4
>内核版本 Linux version 3.10.0-693.2.2.el7.x86_64 (builder@kbuilder.dev.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-16) (GCC) ) 

### Openresty
>wget https://openresty.org/download/openresty-1.13.6.2.tar.gz
>tar -xzvf openresty-1.13.6.2.tar.gz
>./configure --prefix=/alidata/server/openresty
>make -j4
>make install

### Php7
安装依赖
> yum install libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel \
> libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel
> wget http://cn2.php.net/distributions/php-7.2.9.tar.gz
> tar -xzvf php-7.2.9.tar.gz
> ./configure  --prefix=/alidata/server/php-7.2.9 --with-config-file-path=/alidata/server/php-7.2.9/etc --enable-fpm --with-fpm-user=www > --with-fpm-group=www --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-iconv-dir --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --disable-rpath --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-curl --enable-mbregex --enable-mbstring --enable-ftp --with-gd --with-openssl --with-mhash --enable-pcntl --enable-sockets --with-xmlrpc --enable-zip --enable-soap --without-pear --disable-phar --with-gettext --disable-fileinfo --enable-opcache --enable-maintainer-zts --with-config-file-scan-dir=/alidata/server/php-7.2.9/etc/conf.d --with-config-file-path=/alidata/server/php-7.2.9/etc/ --with-kerberos
> make && make install

> 增加 /etc/init.d/php-fpm
> 服务 管理 service php-fpm (start|stop|reload|restart)
> 增加软连接 ln -s /alidata/server/php-7.2.9/bin/php /usr/local/sbin/php
```
php -v 
PHP 7.2.9 (cli) (built: Jul 24 2018 17:27:24) ( ZTS )
Copyright (c) 1997-2018 The PHP Group
Zend Engine v3.2.0, Copyright (c) 1998-2018 Zend Technologies
```

### Redis 4.0集群
> wget http://download.redis.io/releases/redis-4.0.11.tar.gz
> tar -xzvf redis-4.0.11.tar.gz
> make PREFIX=/alidata/server/redis install

搭建一主两从三哨兵
redis.conf 
```shell
port 6379
bind 127.0.0.1

protected-mode yes
requirepass "password"
daemonize yes

logfile "/alidata/logs/redis/6379.log"

dbfilename "dump-6379.rdb"
dir "/alidata/server/redis/data"

#如若master设置了认证密码，那么所有redis数据节点都配置上masterauth属性
masterauth "password"
```
slave.conf
```shell
port 6380
bind 172.31.233.149
requirepass "password"
protected-mode yes
daemonize yes
logfile "/alidata/logs/redis/6380.log"

dbfilename "dump-6380.rdb"
dir "/alidata/server/redis/data"

#如若master设置了认证密码，那么所有redis数据节点都配置上masterauth属性
masterauth "password"

# Generated by CONFIG REWRITE

slaveof 172.31.233.149 6379
```
```shell
port 6381
bind 172.31.233.149
requirepass "VJX2lIPV1kPmVIHh"
protected-mode yes
daemonize yes
logfile "/alidata/logs/redis/6380.log"

dbfilename "dump-6380.rdb"
dir "/alidata/server/redis/data"

#如若master设置了认证密码，那么所有redis数据节点都配置上masterauth属性
masterauth "VJX2lIPV1kPmVIHh"

# Generated by CONFIG REWRITE
1
slaveof 172.31.233.149 6379
```
sentinel.conf
```shell
port 16379
daemonize yes
protected-mode no
logfile "/alidata/logs/redis/16379.log"
dir "/alidata/server/redis/data"
sentinel monitor mymaster 172.31.233.149 6379 2
#redis数据master节点设置了认证，则需要如下配置
sentinel auth-pass mymaster VJX2lIPV1kPmVIHh
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
```

### Rabbitmq
rabbitmq-erlang
安装yum源
> curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | sudo bash
> yum install erlang.x86_64

rabbitmq-search
安装yum源
> curl -s https://packagecloud.io/install/repositories/rabbitmq/rabbitmq-server/script.rpm.sh | sudo bash

### Go
golang 安装
> wget https://dl.google.com/go/go1.11.linux-amd64.tar.gz

### Etcd
> wget https://github.com/etcd-io/etcd/releases/download/v3.3.9/etcd-v3.3.9-linux-amd64.tar.gz
> ./etcd --data-dir=/alidata/server/etcd/data >/alidata/logs/etcd.log 2>&1 & 

### Mongodb 
> wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-4.0.2.tgz

### Cronsun
> ./cronnode -conf conf/base.json >/alidata/logs/cronsun.log 2>&1 & 
> ./cronweb -conf conf/base.json >/alidata/logs/cronweb.log 2>&1 & 
授权认证很粗糙
> 用 aproxy
> https://github.com/shunfei/aproxy/releases/download/v0.2/aproxy-v0.2-linux-amd64-go1.7.3-git1e22ccd.tar.gz

### Acme.sh Ssl证书
```
[Thu Sep 13 11:27:21 CST 2018] Installing from online archive.
[Thu Sep 13 11:27:21 CST 2018] Downloading https://github.com/Neilpang/acme.sh/archive/master.tar.gz
[Thu Sep 13 11:27:23 CST 2018] Extracting master.tar.gz
[Thu Sep 13 11:27:23 CST 2018] It is recommended to install socat first.
[Thu Sep 13 11:27:23 CST 2018] We use socat for standalone server if you use standalone mode.
[Thu Sep 13 11:27:23 CST 2018] If you don't use standalone mode, just ignore this warning.
[Thu Sep 13 11:27:23 CST 2018] Installing to /root/.acme.sh
[Thu Sep 13 11:27:23 CST 2018] Installed to /root/.acme.sh/acme.sh
[Thu Sep 13 11:27:23 CST 2018] Installing alias to '/root/.bashrc'
[Thu Sep 13 11:27:23 CST 2018] OK, Close and reopen your terminal to start using acme.sh
[Thu Sep 13 11:27:23 CST 2018] Installing alias to '/root/.cshrc'
[Thu Sep 13 11:27:23 CST 2018] Installing alias to '/root/.tcshrc'
[Thu Sep 13 11:27:23 CST 2018] Installing cron job
no crontab for root
no crontab for root
[Thu Sep 13 11:27:23 CST 2018] Good, bash is found, so change the shebang to use bash as preferred.
[Thu Sep 13 11:27:24 CST 2018] OK
[Thu Sep 13 11:27:24 CST 2018] Install success!
```

> acme.sh --install-cert -d api.test.com \
> --cert-file /etc/nginx/certs/api.test.com/cert \
> --key-file /etc/nginx/certs/api.test.com/key \
> --fullchain-file /etc/nginx/certs/api.test.com/fullchain \
> --reloadcmd "systemctl reload nginx.service"
