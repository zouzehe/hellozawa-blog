---
title: Linux 执行 df 和 du 查看磁盘时结果不一致
date: 2018-05-22 03:07:09
tags: linux
---
### 问题现象
- 执行 df -h 查看 ECS Linux 实例文件系统使用率，可以看到 /dev/xvdb1 磁盘占用了约27G，挂载目录为 /opt 。
![](/images/df.jpg)
- 进入到 /opt 目录执行 du -sh ，显示空间总占用量约 2.4 G，即df 和du查看到的结果不一致。
![](/images/df.jpg)
### 原因分析
- du 命令对统计文件逐个进行 fstat 系统调用，获取文件大小。它的数据是基于文件获取，可以跨多个分区操作。
- df 命令使用 statfs 系统调用，直接读取分区的超级块信息获取分区使用情况。它的数据基于分区元数据，只能针对整个分区。
- 删除了大量的文件后，du 就不会在文件系统目录中统计这些文件。如果此时还有运行中的进程持有这个已经被删除的文件句柄，那么这个文件就不会真正在磁盘中被删除，分区超级块中的信息也就不会更改，df 仍会统计这个被删除的文件。
- 通过 lsof 查询处于 deleted 状态的文件，被删除的文件在系统中被标记为 deleted 。如果系统有大量 deleted 状态的文件，会导致 du 和 df 统计结果不一致。
```shell
lsof |grep deleted       //在opt目录下执行lsof |grep deleted
```
### 解决方案
- 根据 lsof 列出的 pid，kill 相应进程或者重启相应的服务，如：#kill -9 692。
- 重启实例。重启实例系统会退出现有的进程，开机后重新加载，过程中会释放调用的 deleted 文件的句柄。